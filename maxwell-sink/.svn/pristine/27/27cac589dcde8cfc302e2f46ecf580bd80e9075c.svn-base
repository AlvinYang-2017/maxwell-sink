package com.cimc.maxwell.sink.filter;

import com.cimc.maxwell.sink.row.RowMap;
import org.apache.commons.lang3.StringUtils;

import java.util.HashMap;
import java.util.Map;

/**
 * Created by 00013708 on 2017/8/11.
 */
public class ConditionFilter {

    private final Map<String,String> conditionsMap;

    public ConditionFilter(final String filterConditions){
        this.conditionsMap = initConditionsMap(filterConditions);
    }

    private Map<String,String> initConditionsMap(String filterConditions) {
        if(StringUtils.isEmpty(filterConditions)){
            throw new IllegalArgumentException("filterConditions config null");
        }
        Map<String,String> map = new HashMap<>();
        String[] conditionPairs = filterConditions.split(";");
        for(String condition:conditionPairs){
            String[] arr = condition.split(":");
            String key = arr[0];
            String val = arr[1];
            map.put(key,val);
        }
        return map;
    }

    public boolean match(RowMap rowMap) {
        if(rowMap==null){
            return false;
        }
        Map<String,Object> data = rowMap.getData();
        if(data==null||data.isEmpty()){
            return false;
        }

        Map<String,Object> dataMap = rowMap.getData();
        //遍历条件，所有满足返回真
        boolean fitAllConditions = true;
        for(Map.Entry<String, String> entry:conditionsMap.entrySet()){
            String conditionKey = entry.getKey();
            String conditionVal = entry.getValue();
            //得到data中的实际值
            String val = (String)dataMap.get(conditionKey);
            if(!conditionVal.contains(val)){
                fitAllConditions = false;
                break;
            }
        }
        return fitAllConditions;
    }

    public static void main(String[] args){
        String filterConditions = "sn:100000A011,100000A012,100000A013";
        ConditionFilter filter = new ConditionFilter(filterConditions);

        RowMap rowMap = new RowMap();
        Map<String,Object> dataMap = new HashMap<>();
        dataMap.put("sn","100000A011");
        rowMap.setData(dataMap);

        boolean match = filter.match(rowMap);
        System.out.println(match);
    }
}
